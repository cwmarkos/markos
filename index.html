<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>CSV2HTML</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  </head>
  <body class="bg-light">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <form id="form" novalidate>
            <div class="row">
              <div class="col-md-4 mb-4">
                <label for="principal">元本</label>
                <input type="number" class="form-control" id="principal" placeholder="" value="1" required>
                <div class="invalid-feedback"></div>
              </div>
              <div class="col-md-4 mb-4">
                <label for="premium_type">掛け金種類</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="premium_type" id="simple" value="simple" checked required>
                    <label class="form-check-label" for="simple">固定金額</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="premium_type" id="compound" value="compound">
                    <label class="form-check-label" for="compound">複利金額</label>
                  </div>
                </div>
                <div class="invalid-feedback"></div>
              </div>
              <div class="col-md-4 mb-4">
                <label for="premium_value">掛け金</label>
                <input type="number" class="form-control" id="premium_value" placeholder="" value="2" required>
                <div class="invalid-feedback"></div>
              </div>
              <div class="col-md-4 mb-4">
                <label for="increase_rate">増額率</label>
                <input type="number" class="form-control" id="increase_rate" placeholder="" value="3" required>
                <div class="invalid-feedback"></div>
              </div>
              <div class="col-md-4 mb-4">
                <label for="csv">CSV</label>
                <input type="file" class="form-control" id="csv" required2>
                <div class="invalid-feedback"></div>
              </div>

              <div class="col-md-4 mb-4">
                <label for="display">表示</label>
                <button id="display" class="btn btn-primary btn-block" type="button">表示</button>
              </div>
            </div>

            <hr class="mb-4">
          </form>
          <div class="col-md-12">
            <canvas id="myChart"></canvas>
          </div>
        </div>
      </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
    <script>
      $(document).ready(function() {
        var principal, premium_type, premium_value, increase_rate;
        var csv_raw;
        var csv_data = {
          currency: null,
          asset: [],
          timestamp: [],
        };
        var readFile = function(f) {
          var reader = new FileReader();
          reader.onload = function () {
            csv_raw = reader.result;
          };
          reader.readAsBinaryString(f);
        };
        $("#csv").on('change',function(e){
          var f = e.target.files[0];
          if(f) readFile(f);
        });

        $("#display").click(function(e) {
          var form = $('#form')[0];
          if (form.checkValidity() === false) {
            e.preventDefault();
            e.stopPropagation();
            form.classList.add('was-validated');
          } else {
            var principal = $('#principal').val();
            var asset = principal;
            var premium_type = $('input[name=premium_type]:checked').val();
            var premium_value = $('#premium_value').val();
            var increase_rate = $('#increase_rate').val();

            var lines = csv_raw.split(/\r\n|\n/);
            for (var i=0; i<lines.length; i++) {
              var data = lines[i].split('|');
              if(data[1] === 'WIN') {
                if(premium_type === 'simple') {
                  asset = asset + premium_value * (1 + increase_rate / 100);
                } else {
                  asset = asset + asset * premium_value / 100 * (1 + increase_rate / 100);
                }
                console.log(asset)
              } else if(data[1] === 'LOSE') {
                if(premium_type === 'simple') {
                  asset = asset - premium_value;
                } else {
                  asset = asset - asset * premium_value / 100;
                }
              } else {
                continue;
              }
              csv_data['asset'].push(asset);
              csv_data['timestamp'].push(new Date(data[2] * 1000).toISOString().split('T')[0]);
              csv_data['currency'] = data[0];
            }

            var ctx = document.getElementById("myChart").getContext('2d');
            var config = {
              type: 'line',
              data: {
                labels: csv_data['timestamp'],
                datasets: [{
                  label: "資産",
                  data: csv_data['asset'],
                  fill: false,
                }]
              },
              options: {
                responsive: true,
                hover: {
                  mode: 'nearest',
                  intersect: true
                },
                scales2: {
                  xAxes: [{
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'Month'
                    }
                  }],
                  yAxes: [{
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'Value'
                    }
                  }]
                }
              }
            };

          }
          var myChart = new Chart(ctx, config)

        });
      });
    </script>
  </body>
</html>
